const Address = require('../models/Address');
const UserData = require('../models/UserData');

// NOTE: No longer need createOrUpdateProfile - users exist only in Firebase
// User data (VIP progress) is auto-created on first access
  try {
    const { uid } = req.user; // From Firebase token
    const { name, phone, email } = req.body;

    // Validate required fields
    if (!name || !phone) {
      return res.status(400).json({
        success: false,
        message: 'Name and phone are required'
      });
    }

    // Find existing user or create new one
    let user = await User.findOne({ firebaseUid: uid });

    if (user) {
      // Update existing user
      user.name = name;
      user.phone = phone;
      if (email) user.email = email;
      await user.save();

      return res.json({
        success: true,
        message: 'Profile updated successfully',
        data: user
      });
    } else {
      // Create new user
      user = new User({
        firebaseUid: uid,
        name,
        phone,
        email: email || ''
      });
      await user.save();

      return res.status(201).json({
        success: true,
        message: 'Profile created successfully',
        data: user
      });
    }
  } catch (error) {
    console.error('Create/Update profile error:', error);
    
    if (error.code === 11000) {
      return res.status(400).json({
        success: false,
        message: 'Phone number already exists'
      });
    }

    res.status(500).json({
      success: false,
      message: 'Failed to create/update profile',
      error: error.message
    });
  }
};

/**
 * Get user profile
 * GET /api/users/profile
 */
exports.getProfile = async (req, res) => {
  try {
    const { uid } = req.user;

    const user = await User.findOne({ firebaseUid: uid });

    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'User profile not found'
      });
    }

    res.json({
      success: true,
      data: user
    });
  } catch (error) {
    console.error('Get profile error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to fetch profile',
      error: error.message
    });
  }
};

/**
 * Update VIP progress
 * PUT /api/users/vip-progress
 */
exports.updateVipProgress = async (req, res) => {
  try {
    const { uid } = req.user;
    const { totalOrders, totalEarnings } = req.body;

    const user = await User.findOne({ firebaseUid: uid });

    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'User not found'
      });
    }

    if (totalOrders !== undefined) user.totalOrders = totalOrders;
    if (totalEarnings !== undefined) user.totalEarnings = totalEarnings;

    // Update VIP progress based on orders
    user.updateVipProgress();
    await user.save();

    res.json({
      success: true,
      message: 'VIP progress updated',
      data: {
        vipProgress: user.vipProgress,
        vipLevel: user.vipLevel,
        totalOrders: user.totalOrders,
        totalEarnings: user.totalEarnings
      }
    });
  } catch (error) {
    console.error('Update VIP progress error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to update VIP progress',
      error: error.message
    });
  }
};

/**
 * Add or update address
 * POST /api/users/addresses
 */
exports.addAddress = async (req, res) => {
  try {
    const { uid } = req.user;
    const { label, address, latitude, longitude, isDefault } = req.body;

    if (!label || !address) {
      return res.status(400).json({
        success: false,
        message: 'Label and address are required'
      });
    }

    const user = await User.findOne({ firebaseUid: uid });

    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'User not found'
      });
    }

    // If setting as default, remove default from other addresses
    if (isDefault) {
      user.addresses.forEach(addr => addr.isDefault = false);
    }

    // Add new address
    user.addresses.push({
      label,
      address,
      latitude: latitude || 0,
      longitude: longitude || 0,
      isDefault: isDefault || false
    });

    await user.save();

    res.json({
      success: true,
      message: 'Address added successfully',
      data: user.addresses
    });
  } catch (error) {
    console.error('Add address error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to add address',
      error: error.message
    });
  }
};

/**
 * Get all addresses
 * GET /api/users/addresses
 */
exports.getAddresses = async (req, res) => {
  try {
    const { uid } = req.user;

    const user = await User.findOne({ firebaseUid: uid });

    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'User not found'
      });
    }

    res.json({
      success: true,
      data: user.addresses
    });
  } catch (error) {
    console.error('Get addresses error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to fetch addresses',
      error: error.message
    });
  }
};

/**
 * Delete address
 * DELETE /api/users/addresses/:addressId
 */
exports.deleteAddress = async (req, res) => {
  try {
    const { uid } = req.user;
    const { addressId } = req.params;

    const user = await User.findOne({ firebaseUid: uid });

    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'User not found'
      });
    }

    user.addresses = user.addresses.filter(
      addr => addr._id.toString() !== addressId
    );

    await user.save();

    res.json({
      success: true,
      message: 'Address deleted successfully',
      data: user.addresses
    });
  } catch (error) {
    console.error('Delete address error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to delete address',
      error: error.message
    });
  }
};

/**
 * Delete user account
 * DELETE /api/users/profile
 */
exports.deleteAccount = async (req, res) => {
  try {
    const { uid } = req.user;

    const user = await User.findOneAndDelete({ firebaseUid: uid });

    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'User not found'
      });
    }

    res.json({
      success: true,
      message: 'Account deleted successfully'
    });
  } catch (error) {
    console.error('Delete account error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to delete account',
      error: error.message
    });
  }
};
